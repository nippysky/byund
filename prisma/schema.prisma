generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum DashboardMode {
  TEST
  LIVE
}

enum PaymentLinkMode {
  FIXED
  VARIABLE
}

enum PaymentStatus {
  CREATED
  SUBMITTED
  CONFIRMED
  FAILED
  CANCELED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  merchant Merchant?
  sessions Session[]
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Merchant {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  publicName       String
  settlementWallet String?

  dashboardMode DashboardMode @default(TEST)

  brandBg   String @default("#0066FF")
  brandText String @default("#FFFFFF")

  onboardingStep        Int      @default(0)
  onboardingCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links PaymentLink[]

  apiKeys          ApiKey[]
  webhookEndpoints WebhookEndpoint[]
}


model PaymentLink {
  id              String         @id @default(cuid())
  publicId         String        @unique
  merchantId       String
  merchant         Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  environment      DashboardMode  @default(LIVE)

  name             String
  description      String?
  currency         String         @default("USD")
  mode             PaymentLinkMode
  fixedAmountCents Int?
  isActive         Boolean        @default(true)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  payments         Payment[]

  @@index([merchantId])
  @@index([merchantId, environment])
  @@index([isActive])
}

model Payment {
  id               String        @id @default(cuid())
  linkId           String
  link             PaymentLink   @relation(fields: [linkId], references: [id], onDelete: Cascade)

  amountUsdCents   Int
  amountUsdcMicros BigInt

  payerAddress     String?
  chainId          Int           @default(8453)
  tokenAddress     String
  txHash           String?       @unique

  status           PaymentStatus @default(CREATED)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  confirmedAt      DateTime?

  @@index([linkId, createdAt])
  @@index([status])
}

enum ApiKeyType {
  SECRET
  PUBLISHABLE
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
}

model ApiKey {
  id          String       @id @default(cuid())
  merchantId  String
  merchant    Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  environment DashboardMode @default(TEST)
  type        ApiKeyType
  name        String?
  status      ApiKeyStatus  @default(ACTIVE)

  keyHash     String       @unique
  prefix      String
  last4       String
  scopes      String[]     @default([])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  revokedAt   DateTime?

  @@index([merchantId, environment])
  @@index([merchantId, type])
  @@index([prefix])
  @@index([status])
}

enum WebhookEventType {
  payment_created
  payment_submitted
  payment_confirmed
  payment_failed
  payment_canceled
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
}

model WebhookEndpoint {
  id                  String                 @id @default(cuid())
  merchantId           String
  merchant             Merchant              @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  environment          DashboardMode         @default(TEST)

  url                 String
  description         String?

  signingSecretHash   String
  signingSecretLast4  String

  isActive            Boolean                @default(true)

  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  events              WebhookEndpointEvent[]
  deliveries          WebhookDelivery[]

  @@index([merchantId, environment])
  @@index([isActive])
}

model WebhookEndpointEvent {
  endpointId String
  endpoint   WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  eventType  WebhookEventType
  createdAt  DateTime        @default(now())

  @@id([endpointId, eventType])
  @@index([eventType])
}

model WebhookDelivery {
  id            String               @id @default(cuid())
  endpointId    String
  endpoint      WebhookEndpoint      @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  eventType     WebhookEventType
  eventId       String
  payload       Json

  status        WebhookDeliveryStatus @default(PENDING)
  attemptCount  Int                   @default(0)

  lastAttemptAt DateTime?
  nextAttemptAt DateTime?

  httpStatus    Int?
  responseBody  String?

  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@unique([endpointId, eventId])
  @@index([endpointId, createdAt])
  @@index([status, nextAttemptAt])
}
